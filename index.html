<!DOCTYPE html>
<html>
<head>
  <title>UWH Scoreboard</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #1b1f3b;
      color: #ffffff;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.5s;
    }

    #logo {
      width: 400px;
      max-width: 80%;
      margin-top: 30px;
      cursor: pointer;
    }

    #time {
      font-size: 10vw;
      margin: 1vh 0 2vh;
    }

    .team-blocks {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 90%;
      max-width: 900px;
      margin-top: 1vh;
    }

    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .team-name {
      font-size: 2.5vw;
      font-weight: bold;
      margin-bottom: 0.5vh;
    }

    .team-score {
      font-size: 7vw;
      font-weight: bold;
    }

    .divider {
      width: 2px;
      height: 10vw;
      background: rgba(255, 255, 255, 0.4);
    }

    .halftime {
      background-color: #7c0a02 !important;
    }
  </style>
</head>
<body>
  <img id="logo" src="https://docs.google.com/drawings/d/e/2PACX-1vQthbu25WufVsdyuxQOvj6Q3ColCj6gv5NB_nQsXCWAuGGNj3N9bBoTWPvfkJSrsEfX8IUFZKEDJK8c/pub?w=1440&h=1080" alt="Logo" />
  <div id="time">Loading...</div>

  <div class="team-blocks">
    <div class="team">
      <div id="team1" class="team-name">Team A</div>
      <div id="score1" class="team-score">0</div>
    </div>
    <div class="divider"></div>
    <div class="team">
      <div id="team2" class="team-name">Team B</div>
      <div id="score2" class="team-score">0</div>
    </div>
  </div>

  <audio id="buzzer" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const SHEET_ID = "1b6gofMejj1tXHA1o-yFvCBuV6RhMRiPbTl8iJQY8SzY";
      const API_KEY = "AIzaSyCaxh4c4PwWwCM3zVm35FoNlaY5NbXWH7c";
      const RANGE = "Settings!B2:B11";
      const WRITE_RANGE = "Settings!B9";
      const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const WRITE_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${WRITE_RANGE}?valueInputOption=RAW&key=${API_KEY}`;

      const timeElem = document.getElementById("time");
      const buzzer = document.getElementById("buzzer");
      const logo = document.getElementById("logo");

      let matchLength = 0;
      let halftimeLength = 0;
      let halftimeStart = 0;
      let halftimeTimer = 0;
      let timeRemaining = 0;
      let countdownInterval = null;
      let firstLoad = true;
      let phase = "first";
      let paused = true;
      let useHalftime = true;

      function parseTimeToSeconds(timeStr) {
        if (!timeStr || timeStr.trim() === "") return 0;
        const parts = timeStr.split(":");
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      }

      function formatTime(seconds) {
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        return `${mins}:${secs}`;
      }

      async function fetchData() {
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          const rows = data.values;

          if (rows && rows.length >= 9) {
            const newMatch = parseTimeToSeconds(rows[0][0]);
            const newHalftime = parseTimeToSeconds(rows[1][0]);
            const statusValue = (rows[8][0] || '').toLowerCase();

            if (statusValue === "pause") {
              paused = true;
            } else if (statusValue === "play") {
              if (phase === "halftime-pause") {
                paused = false;
                phase = "halftime";
              } else {
                paused = false;
              }
            }

            if (firstLoad) {
              matchLength = newMatch;
              halftimeLength = newHalftime;
              useHalftime = halftimeLength > 0;
              halftimeStart = useHalftime ? Math.floor(matchLength / 2) : 0;
              timeRemaining = matchLength;
              timeElem.textContent = formatTime(timeRemaining);
              firstLoad = false;
            }

            document.getElementById("team1").textContent = rows[3][0] || 'Team A';
            document.getElementById("score1").textContent = rows[4][0] || '0';
            document.getElementById("team2").textContent = rows[5][0] || 'Team B';
            document.getElementById("score2").textContent = rows[6][0] || '0';
          }
        } catch (err) {
          console.error("Error fetching sheet data:", err);
        }
      }

      async function updateTimerInSheet(time) {
        const body = JSON.stringify({ values: [[time]] });
        try {
          await fetch(WRITE_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body
          });
        } catch (err) {
          console.error("Error updating timer:", err);
        }
      }

      function startClock() {
        if (countdownInterval) return;
        countdownInterval = setInterval(() => {
          if (paused || phase === "end") return;

          if (phase === "first") {
            timeRemaining--;
            timeElem.textContent = formatTime(timeRemaining);
            updateTimerInSheet(timeElem.textContent);
            if (useHalftime && timeRemaining === halftimeStart) {
              buzzer.play();
              phase = "halftime-pause";
              paused = true;
              document.body.classList.add("halftime");
              halftimeTimer = 0;
            }
          } else if (phase === "halftime") {
            halftimeTimer++;
            timeElem.textContent = formatTime(halftimeTimer);
            updateTimerInSheet(timeElem.textContent);
            if (halftimeTimer >= halftimeLength) {
              buzzer.play();
              phase = "second";
              timeRemaining = halftimeStart;
              document.body.classList.remove("halftime");
            }
          } else if (phase === "second") {
            timeRemaining--;
            timeElem.textContent = formatTime(timeRemaining);
            updateTimerInSheet(timeElem.textContent);
            if (timeRemaining === 0) {
              buzzer.play();
              phase = "end";
              timeElem.textContent = "00:00";
              updateTimerInSheet("00:00");
            }
          }
        }, 1000);
      }

      logo.addEventListener("click", () => {
        buzzer.play().then(() => {
          buzzer.pause();
          buzzer.currentTime = 0;
        }).catch(() => {});

        if (phase === "halftime-pause") {
          paused = false;
          phase = "halftime";
        } else {
          paused = !paused;
        }

        if (!countdownInterval) {
          startClock();
        }
      });

      fetchData();
      setInterval(fetchData, 1000);
    });
  </script>
</body>
</html>
