<script>
  const SHEET_ID = "1b6gofMejj1tXHA1o-yFvCBuV6RhMRiPbTl8iJQY8SzY";
  const API_KEY = "AIzaSyCaxh4c4PwWwCM3zVm35FoNlaY5NbXWH7c";
  const RANGE = "Settings!B1:B7";
  const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

  const timeElem = document.getElementById("time");
  const buzzer = document.getElementById("buzzer");

  let matchLength = 0;
  let halftimeLength = 0;
  let halftimeStart = 0;
  let halftimeTimer = 0;
  let timeRemaining = 0;
  let countdownInterval = null;
  let firstLoad = true;
  let phase = "first"; // "first", "halftime", "second", "end"

  function parseTimeToSeconds(timeStr) {
    const parts = timeStr.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
  }

  function formatTime(seconds) {
    const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${mins}:${secs}`;
  }

  async function fetchData() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      const rows = data.values;

      if (rows && rows.length >= 7) {
        const newMatch = parseTimeToSeconds(rows[0][0]);
        const newHalftime = parseTimeToSeconds(rows[1][0]);

        if (firstLoad) {
          matchLength = newMatch;
          halftimeLength = newHalftime;
          halftimeStart = Math.floor(matchLength / 2);
          timeRemaining = matchLength;
          startClock();
          firstLoad = false;
        }

        document.getElementById("team1").textContent = rows[3][0] || 'Team A';
        document.getElementById("score1").textContent = rows[4][0] || '0';
        document.getElementById("team2").textContent = rows[5][0] || 'Team B';
        document.getElementById("score2").textContent = rows[6][0] || '0';
      }
    } catch (err) {
      console.error("Error fetching sheet data:", err);
    }
  }

  function startClock() {
    timeElem.textContent = formatTime(timeRemaining);

    countdownInterval = setInterval(() => {
      if (phase === "first") {
        timeRemaining--;
        timeElem.textContent = formatTime(timeRemaining);
        if (timeRemaining === halftimeStart) {
          buzzer.play();
          phase = "halftime";
          document.body.classList.add("halftime");
          halftimeTimer = 0;
        }
      } else if (phase === "halftime") {
        halftimeTimer++;
        timeElem.textContent = formatTime(halftimeTimer);
        if (halftimeTimer >= halftimeLength) {
          buzzer.play();
          phase = "second";
          document.body.classList.remove("halftime");
          timeRemaining = halftimeStart;
        }
      } else if (phase === "second") {
        timeRemaining--;
        timeElem.textContent = formatTime(timeRemaining);
        if (timeRemaining === 0) {
          buzzer.play();
          phase = "end";
        }
      } else if (phase === "end") {
        timeElem.textContent = "00:00";
      }
    }, 1000);
  }

  fetchData();
  setInterval(fetchData, 5000); // Only updates names/scores now
</script>
